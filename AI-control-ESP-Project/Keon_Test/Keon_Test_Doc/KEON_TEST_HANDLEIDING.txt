KEON TEST - COMPLETE HANDLEIDING & DOCUMENTATIE
==============================================
Laatste update: 2025-09-16 21:34 UTC
Hardware: LilyGO TTGO T-Display V1.1 ESP32
Project: Kiiroo Keon BLE Test Interface

OVERZICHT
=========
Deze code implementeert een complete test interface voor de Kiiroo Keon via Bluetooth Low Energy.
De code gebruikt het gedocumenteerde Kiiroo v2 protocol (Fleshlight Launch compatibel) en biedt
zowel een visuele interface op het TTGO display als uitgebreide serial monitor commando's.

HARDWARE VEREISTEN
==================
- LilyGO TTGO T-Display V1.1 ESP32 (1.14" 135x240 display)
- Nintendo Nunchuk (optioneel, voor realtime besturing)
- Kiiroo Keon device
- Arduino IDE met ESP32 board support

VEREISTE LIBRARIES
==================
1. TFT_eSPI - Voor display besturing
2. NintendoExtensionCtrl - Voor Nunchuk support
3. NimBLE-Arduino - Voor Bluetooth Low Energy functionaliteit

Installatie NimBLE-Arduino:
- Open Arduino IDE
- Ga naar Tools > Manage Libraries
- Zoek naar "NimBLE-Arduino"
- Installeer de nieuwste versie

NIEUWE FUNCTIONALITEIT (TOEGEVOEGD)
===================================

1. ECHTE BLE IMPLEMENTATIE
--------------------------
✅ NimBLE-Arduino library integratie
✅ Kiiroo v2 protocol implementatie (Fleshlight Launch compatible)
✅ Automatische device scanning en herkenning
✅ Proper connection management met error handling
✅ Real-time 2-byte commando protocol [position, speed] (0-99 range)

2. UITGEBREIDE SERIAL COMMAND INTERFACE
---------------------------------------
Complete set van commando's voor testing via Serial Monitor:

BLE COMMANDS:
-------------
scan              - Scan for Kiiroo devices (10 seconden)
connect <addr>    - Connect direct naar MAC address (bijv: connect aa:bb:cc:dd:ee:ff)
keon              - Probeer automatisch Keon te vinden en connecten
solace            - Probeer automatisch Solace te vinden en connecten
disconnect        - Disconnect alle verbonden devices
status            - Toon complete connection status

KEON CONTROL COMMANDS (wanneer verbonden):
------------------------------------------
move <pos> <spd>  - Stuur positie (0-99) en snelheid (0-99) naar Keon
pos <0-99>        - Zet alleen positie (snelheid blijft hetzelfde)
speed <0-99>      - Zet alleen snelheid (positie blijft hetzelfde)
stop              - Stop beweging (snelheid = 0, positie blijft)

TEST COMMANDS:
--------------
demo              - Volledige geautomatiseerde demo sequence
test stroke       - Test stroke patronen (langzaam/medium/snel)
test positions    - Test alle posities 0-99 in stappen
test speeds       - Test alle snelheden 0-99 in stappen  
test wave         - Vloeiende sine golf beweging (3 cycli)

INFO COMMANDS:
--------------
devices           - Lijst van alle ontdekte BLE devices
nunchuk           - Toon huidige nunchuk status en waardes
help              - Toon alle beschikbare commando's

3. NUNCHUK REAL-TIME CONTROL
----------------------------
✅ Y-joystick → Keon positie (0-99, omgekeerd voor natuurlijke besturing)
✅ X-joystick → Keon snelheid (center=0, edges=max snelheid)
✅ Automatische rate limiting (20Hz max, zoals aanbevolen in documentatie)
✅ Deadzone voor X-joystick om accidentele snelheid te voorkomen
✅ Live feedback op display met positie en snelheid waardes

4. PROTOCOL IMPLEMENTATIE DETAILS
---------------------------------
Gebaseerd op de Kiiroo v2 familie documentatie:

PRIMARY UUIDs (Fleshlight Launch compatible):
- Service:      88f80580-0000-01e6-aace-0002a5d5c51b
- Data Write:   88f80581-0000-01e6-aace-0002a5d5c51b
- Status Notify:88f80582-0000-01e6-aace-0002a5d5c51b  
- Command:      88f80583-0000-01e6-aace-0002a5d5c51b

FALLBACK UUIDs (Kiiroo Onyx 2 compatible):
- Service:      f60402a6-0294-4bdb-9f20-6758133f7090
- Data:         02962ac9-e86f-4094-989d-231d69995fc2
- Status:       d44d0393-0731-43b3-a373-8fc70b1f3323
- Command:      c7b7a04b-2cc4-40ff-8b10-5d531d1161db

COMMANDO PROTOCOL:
- Initialisatie: 0x00 naar Command characteristic (switches to user mode)
- Beweging: 2 bytes [YY, ZZ] naar Data characteristic
  - YY = positie (0-99): 0=bottom, 99=top
  - ZZ = snelheid (0-99): 0=stop, 99=fastest
- Rate limiting: Max 20Hz (50ms interval) om buffer overrun te voorkomen

5. DEBUGGING & MONITORING
-------------------------
✅ Uitgebreide Serial logging voor alle BLE events
✅ Real-time connection status monitoring  
✅ Device discovery logging met Kiiroo herkenning
✅ Command success/failure feedback
✅ Automatic reconnection attempts voor Nunchuk

GEBRUIKSINSTRUCTIES
===================

STAP 1: HARDWARE SETUP
----------------------
1. Sluit Nintendo Nunchuk aan op I2C (SDA=21, SCL=22)
2. Upload de code naar TTGO T-Display V1.1
3. Zet Keon aan en zorg dat hij in pairing mode staat (blauwe LED knippert)

STAP 2: EERSTE OPSTART
----------------------
1. Open Serial Monitor (115200 baud)
2. Reset de ESP32
3. Wacht op "[SETUP] Keon Test ready!" bericht
4. Type 'help' voor alle beschikbare commando's

STAP 3: KEON VERBINDING
-----------------------
Via Serial Monitor:
1. Type 'scan' om te zoeken naar Kiiroo devices
2. Type 'keon' om automatisch te connecten
3. Type 'status' om verbinding te controleren

Via Display Interface:
1. Gebruik Nunchuk joystick Y om tussen Keon/Solace te navigeren
2. Druk Z knop of rechter TTGO knop om connectie popup te openen
3. Kies 'Ja' om te verbinden

STAP 4: TESTEN
--------------
Via Serial Monitor (aanbevolen voor uitgebreid testen):
- Type 'demo' voor volledige geautomatiseerde test
- Type 'test stroke' voor stroke patronen
- Type 'move 50 30' voor handmatige besturing (positie 50, snelheid 30)
- Type 'test wave' voor vloeiende beweging

Via Nunchuk (real-time besturing):
- Y-joystick omhoog/omlaag = positie
- X-joystick links/rechts = snelheid
- C knop = terug naar menu

TECHNICAL IMPLEMENTATION DETAILS
================================

BLE DEVICE SCANNING:
-------------------
- Actieve scan gedurende 8-10 seconden
- Automatische herkenning via device names ("Keon", "Launch", "Onyx", etc.)
- Service UUID matching voor Kiiroo devices
- Callback-based device discovery met duplicate filtering

CONNECTION MANAGEMENT:
---------------------
- Multi-step connection process: scan → connect → service discovery → characteristic mapping
- Fallback UUID support voor verschillende Kiiroo models
- Proper error handling en cleanup bij connection failures
- Automatic initialization (0x00 command) voor user mode

COMMAND PROTOCOL:
----------------
- 2-byte commands volgens Kiiroo v2 specificatie
- WriteWithoutResponse voor optimale performance
- Rate limiting (50ms minimum interval) om device buffer te respecteren
- Constrain values naar 0-99 range zoals vereist door protocol

NUNCHUK INTEGRATION:
-------------------
- I2C communicatie op pinnen 21/22
- Automatic reconnection bij connection loss
- Deadzone implementatie voor accidentele input preventie
- Real-time mapping naar Keon coordinates

TROUBLESHOOTING
===============

KEON WORDT NIET GEVONDEN:
-------------------------
1. Controleer of Keon in pairing mode staat (blauwe LED knippert)
2. Probeer Keon power cycle (15 seconden vasthouden voor pairing reset)
3. Type 'scan' in Serial Monitor om alle devices te zien
4. Gebruik 'connect <MAC address>' voor directe verbinding

VERBINDING LUKT NIET:
--------------------
1. Controleer Serial Monitor voor error berichten
2. Sommige Kiiroo devices vereisen OS pairing eerst
3. Probeer disconnect en opnieuw connecten
4. Reset ESP32 en probeer opnieuw

NUNCHUK WERKT NIET:
------------------
1. Controleer I2C bekabeling (SDA=21, SCL=22)
2. Serial Monitor toont Nunchuk status bij startup
3. Type 'nunchuk' om huidige waardes te zien
4. Automatische reconnection probeert elke 2 seconden

COMMANDO'S WERKEN NIET:
----------------------
1. Type 'status' om verbinding te controleren
2. Keon moet connected zijn voordat commando's werken
3. Controleer Serial Monitor voor command feedback
4. Respecteer rate limiting (niet te snel commando's sturen)

SERIAL COMMAND VOORBEELDEN
==========================

BASIC TESTING SEQUENCE:
-----------------------
1. help                    (toon alle commando's)
2. scan                    (zoek naar devices)
3. keon                    (verbind met Keon)
4. status                  (controleer verbinding)
5. demo                    (run complete test)

HANDMATIGE BESTURING:
--------------------
move 0 30       (naar bottom, langzaam)
move 99 50      (naar top, medium snelheid)
move 50 0       (naar middle, stop)
pos 75          (naar 75% positie, snelheid ongewijzigd)
speed 80        (snelheid naar 80%, positie ongewijzigd)
stop            (stop beweging)

GEAUTOMATISEERDE TESTS:
----------------------
test positions  (test alle posities 0-99)
test speeds     (test alle snelheden 0-99)  
test stroke     (test stroke patronen)
test wave       (vloeiende sine golf beweging)

MONITORING:
----------
devices         (lijst alle gevonden BLE devices)
status          (complete system status)
nunchuk         (nunchuk waardes en status)

CODE STRUCTUUR
==============

MAIN COMPONENTS:
---------------
- BLE Management (scanning, connecting, protocol)
- UI State Machine (menu, popup, Keon display)
- Input Handling (nunchuk, buttons)
- Serial Command Interface
- Test Functions (demo, stroke patterns, etc.)
- Display Drawing (menu, status, live feedback)

KEY FUNCTIONS:
-------------
scanForKiirooDevices()     - BLE device scanning met Kiiroo herkenning
connectToKiirooDevice()    - Multi-step connection process
sendKiirooCommand()        - Protocol command transmission
handleSerialCommands()     - Complete serial interface
runDemo()                  - Geautomatiseerde test sequence
testWaveMotion()           - Sine wave movement pattern

PROTOCOL CONSTANTS:
------------------
Alle UUIDs en commando bytes zoals gedocumenteerd in:
- Kiiroo_Keon_BLE_API_Notes.txt
- Kiiroo_Keon_Control_DeepDive.txt

SAFETY CONSIDERATIONS
====================

HARDWARE SAFETY:
----------------
- Rate limiting voorkomt device overload
- Proper disconnect bij menu return
- Stop commando voor emergency stop
- Constrain functies voorkomen invalid values

SOFTWARE SAFETY:  
----------------
- Null pointer checks voor alle BLE operations
- Connection state validation voor alle commando's
- Error handling en recovery
- Automatic cleanup bij disconnection

TESTING SAFETY:
---------------
- Start altijd met lage snelheden
- Test sequences bouwen langzaam op
- Stop commando's ingebouwd in alle test functies
- Manual override mogelijk via C knop of 'stop' commando

VERSION HISTORY
===============
v1.0 (2025-09-16): 
- Basis TTGO interface met menu en nunchuk
- Simulated BLE functions (returned false)
- Visual feedback systeem

v2.0 (2025-09-16):
- Complete BLE implementatie met NimBLE
- Kiiroo v2 protocol support
- Real-time Keon besturing
- Uitgebreide serial command interface
- Geautomatiseerde test functions
- Comprehensive debugging features

BRONNEN & REFERENTIES
====================
- Fleshlight Launch protocol: https://buttplug-spec.docs.buttplug.io/docs/stpihkal/protocols/fleshlight-launch/
- Kiiroo Onyx 2 UUIDs: https://buttplug-spec.docs.buttplug.io/docs/stpihkal/protocols/kiiroo-onyx-2/
- Kiiroo Bootloader: https://buttplug-spec.docs.buttplug.io/docs/stpihkal/protocols/kiiroo-bootloader/
- Intiface Central docs: https://docs.intiface.com/docs/intiface-central/brands/kiiroo/
- IoSTIndex Keon specs: https://iostindex.com/devices/kiiroo/keon/

CONTACT & SUPPORT
================
Voor vragen of problemen, controleer:
1. Serial Monitor output voor debug informatie
2. Troubleshooting sectie hierboven
3. Originele documentatie bestanden in project folder

=== EINDE HANDLEIDING ===